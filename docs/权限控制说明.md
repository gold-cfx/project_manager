# 科研项目管理系统权限控制说明

## 概述

本系统实现了基于角色的权限控制系统，只有管理员用户才能执行删除操作。普通用户尝试删除任何数据时都会被拒绝。

## 权限控制规则

### 管理员权限

- **管理员角色**：用户角色为 `admin` 的用户
- **权限范围**：可以执行所有删除操作
- **权限检查**：通过 `SessionManager.is_admin()` 方法检查

### 普通用户权限

- **普通用户角色**：用户角色为 `user` 的用户
- **权限范围**：只能查看和编辑自己的数据，不能删除任何数据
- **限制操作**：所有删除操作都会被拒绝，并显示"权限不足"提示

## 受控的删除操作

以下操作都添加了管理员权限控制：

1. **项目删除**
    - 文件：`logic/project_logic.py`
    - 方法：`delete_project()`
    - 提示："只有管理员才能删除项目"

2. **用户删除**
    - 文件：`logic/user_logic.py`
    - 方法：`delete_user()`
    - 提示："只有管理员才能删除用户"

3. **提醒删除**
    - 文件：`logic/reminder_logic.py`
    - 方法：`delete_reminder()`
    - 提示："只有管理员才能删除提醒"

4. **项目成果删除**
    - 文件：`logic/project_result_logic.py`
    - 方法：`delete_project_result()`
    - 提示："只有管理员才能删除项目成果"

5. **项目成果附件删除**
    - 文件：`logic/project_result_attachment_logic.py`
    - 方法：`delete_attachment()` 和 `delete_result_attachments()`
    - 提示："只有管理员才能删除项目成果附件"

## 权限检查实现

### 后端逻辑层

在每个删除方法的开头添加权限检查：

```python
from utils.session import SessionManager

if not SessionManager.is_admin():
    raise PermissionError("只有管理员才能删除XXX")
```

### 前端UI层

在每个删除操作的UI方法中添加权限检查：

```python
from utils.session import SessionManager

if not SessionManager.is_admin():
    QMessageBox.warning(self, "权限不足", "只有管理员才能删除XXX")
    return
```

## 权限检查工具

### SessionManager 类

位置：`utils/session.py`

主要方法：

- `set_current_user(user)` - 设置当前登录用户
- `get_current_user()` - 获取当前登录用户
- `is_admin()` - 检查是否为管理员
- `is_logged_in()` - 检查是否已登录
- `clear_current_user()` - 清除当前用户会话

### 权限装饰器（可选）

位置：`utils/permission_decorator.py`

提供了装饰器模式来简化权限检查：

- `admin_required` - 管理员权限装饰器
- `admin_required_with_confirm` - 带确认的管理员权限装饰器

## 测试验证

运行测试脚本验证权限控制：

```bash
python test_permission.py
```

测试内容包括：

- 未登录用户权限检查
- 普通用户权限检查
- 管理员用户权限检查
- 各种删除操作的权限验证

## 使用示例

### 管理员用户

- 用户名：admin
- 角色：admin
- 权限：可以执行所有删除操作

### 普通用户

- 用户名：任意非管理员用户
- 角色：user
- 权限：只能查看和编辑，不能删除

## 注意事项

1. 系统默认创建的管理员用户具有完整权限
2. 普通用户无法通过任何方式绕过权限检查
3. 权限检查在业务逻辑层和UI层都有实现，确保双重保护
4. 所有删除操作都会记录操作日志，包括操作者和操作时间

## 扩展建议

如果需要更细粒度的权限控制，可以考虑：

1. 添加项目级别的权限（项目负责人可以删除自己的项目）
2. 添加部门级别的权限
3. 添加操作日志审计功能
4. 添加权限申请和审批流程